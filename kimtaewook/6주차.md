# Lazy Evaluation(지연 실행)과 Action vs Transformation
## Spark 는 지연 실행(Lazy Evaluation)을 한다
- Transformation을 호출해도 즉시 계산하지 않고, 실행 계획(DAG) 만 만든 뒤 Action(동작) 이 호출될 때 실제로 계산(잡 실행)을 시작합니다.
1. Transformation:map, flatMap, filter, mapPartitions, union, distinct, repartition, coalesce, groupByKey, reduceByKey, join
2. Action:collect, count, take(n), first, reduce, foreach, saveAsTextFile, write.parquet, show

### 사용 예시
``` python
# 0.df 라는 데이터프레임을 가정
df = ...

# 1. df 를 읽고
# 2. df의 category 컬럼에서 '신선식품' 을 필터링하는 계획을 세움
fresh_orders = df.filter(col("category") == "신선식품")

# 3. 거기서 '가격'과 '수량' 컬럼만 선택하는 계획을 세운다.
price_quantity = fresh_orders.select("가격", "수량")

'''위에서 만든 계획(DataFrame)에 Action을 실행'''
# 4.이전에 세웠던 계획대로 실행 후 개수를 센다.
# 이 코드가 실행되는 순간 이전 계획들(1.df 를 읽고 2."신선식품"을 필터링 후 3."가격", "수량" 컬럼을 선택)을 실행하고 4.최종 데이터의 개수를 세서 최종 숫자가 total_count 변수에 담긴다
total_count = price_quantity.count() 
```
- 위 코드 중에서 3.까지만 실행하면 Spark 는 실제 연산을 하지 않음
- 그저 category 에서 "신선식품"을 필터링하고 "가격" 과 "수량" 컬럼을 선택하는 계획만 세운다
- 4.코드까지 실행되면 그제서야 이전 계획을 실행하고 전체 개수를 세서 total_count 에 담긴다.

## 왜 Spark 는 지연 실행을 할까?
### **최적화!!!**
- 여러 Transformation을 보고 불필요 하거나 중복 실행되는 작업 등을 줄이고 최적의 실행 계획(연산 재배열, 푸시다운 등)을 세운 후 실행한다.
- 사용자가 **"무엇(What)"** 을 원하는지만 선언적으로 작성하면, **"어떻게(How)"** 가장 효율적으로 실행할지는 시스템이 알아서 최적의 계획을 세워 처리한다.

## Narrow vs Wide(Shuffle)
- Transformation 코드를 보고 최적의 실행 계획을 세울 때 다시 Narrow transformation 와 Wide transformation 를 구분한다.
- Narrow transformation:
    1. 셔플 발생 없음
    2. 각 입력 파티션이 단 하나의 출력 파티션에만 기여하는 변환 --> 매우 빠른 처리 속도
    3. 대표 연산: map, filter, flatMap, union, mapPartitions
- Wide transformation:
    1. 셔플 발생 확률 많음(일부는 셔플 발생량을 줄일 수 있음, coalesce 의 경우 셔플 없이도 실행 가능)
    2. 각 입력 파티션이 여러 출력 파티션에 기여하는 변환 즉, 각 출력 파티션은 여러 입력 파티션에 의존할 수 있음
    3. 셔플이 발생하는 경우 많은 리소스 필요 --> 느림, 병목 현상 발생가능성 높음
    4. 대표 연산: groupByKey, reduceByKey, sortByKey, aggregateByKey, join, distinct, repartition

## 셔플(Shuffle)
- 데이터 그룹화 또는 집계와 같은 후속 처리를 위해 노드 전체에 데이터를 재분배하는 과정

## 참조
- https://pinggoopark.tistory.com/entry/Spark-%EC%8A%A4%ED%8C%8C%ED%81%AC%EC%97%90%EC%84%9C-Shuffle-%EA%B0%9C%EB%85%90
- https://tasty-step-95c.notion.site/spark-shuffle-58b4fe6840cc4101a61cb78020c5eee9